<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube View Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9fafb;
        }
        #viewChart {
            max-height: 400px;
        }
        .error {
            color: red;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">YouTube View Tracker</h1>

        <!-- Form to add video ID -->
        <div class="mb-6">
            <form id="add-video-form" class="flex flex-col sm:flex-row gap-4">
                <input
                    type="text"
                    id="video-id"
                    placeholder="Enter YouTube Video ID (e.g., dQw4w9WgXcQ)"
                    class="p-2 border rounded-lg w-full sm:w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button
                    type="submit"
                    class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition"
                >
                    Add Video
                </button>
            </form>
            <p id="add-error" class="error mt-2">Error: Unable to add video ID</p>
        </div>

        <!-- List of tracked videos -->
        <div class="mb-6">
            <h2 class="text-2xl font-semibold mb-4">Tracked Videos</h2>
            {% if video_ids %}
                <ul class="space-y-2">
                    {% for video_id in video_ids %}
                        <li class="flex justify-between items-center p-2 bg-white rounded-lg shadow">
                            <span>{{ video_id }}</span>
                            <button
                                onclick="removeVideo('{{ video_id }}')"
                                class="bg-red-500 text-white px-4 py-1 rounded-lg hover:bg-red-600 transition"
                            >
                                Remove
                            </button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-gray-500">No videos are being tracked. Add a video ID above.</p>
            {% endif %}
            <p id="remove-error" class="error mt-2">Error: Unable to remove video ID</p>
        </div>

        <!-- Video selection and chart -->
        <div>
            <h2 class="text-2xl font-semibold mb-4">View Data</h2>
            <select
                id="video-select"
                onchange="loadVideoData()"
                class="p-2 border rounded-lg mb-4 w-full sm:w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                <option value="">Select a video to track</option>
                {% for video_id in video_ids %}
                    <option value="{{ video_id }}">{{ video_id }}</option>
                {% endfor %}
            </select>
            <p id="data-error" class="error mb-4">Error: Unable to load video data</p>
            <canvas id="viewChart" class="w-full"></canvas>
        </div>
    </div>

    <script>
        // Add video ID
        document.getElementById('add-video-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const videoId = document.getElementById('video-id').value.trim();
            const addError = document.getElementById('add-error');
            addError.style.display = 'none';

            try {
                const response = await fetch('/add_video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: videoId })
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    addError.textContent = `Error: ${result.message}`;
                    addError.style.display = 'block';
                }
            } catch (error) {
                addError.textContent = 'Error: Network issue or server unavailable';
                addError.style.display = 'block';
            }
        });

        // Remove video ID
        async function removeVideo(videoId) {
            const removeError = document.getElementById('remove-error');
            removeError.style.display = 'none';

            try {
                const response = await fetch(`/remove_video/${videoId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    removeError.textContent = `Error: ${result.message}`;
                    removeError.style.display = 'block';
                }
            } catch (error) {
                removeError.textContent = 'Error: Network issue or server unavailable';
                removeError.style.display = 'block';
            }
        }

        // Load video data and render chart
        let chartInstance = null;
        async function loadVideoData() {
            const videoId = document.getElementById('video-select').value;
            const dataError = document.getElementById('data-error');
            dataError.style.display = 'none';

            if (!videoId) {
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                return;
            }

            try {
                const response = await fetch(`/video_data/${videoId}`);
                const result = await response.json();
                if (result.success) {
                    // Format timestamps to local time
                    result.chart.data.labels = result.chart.data.labels.map(timestamp => 
                        new Date(timestamp).toLocaleString()
                    );
                    // Destroy existing chart if it exists
                    if (chartInstance) {
                        chartInstance.destroy();
                    }
                    // Create new chart
                    const ctx = document.getElementById('viewChart').getContext('2d');
                    chartInstance = new Chart(ctx, result.chart);
                } else {
                    dataError.textContent = `Error: ${result.message}`;
                    dataError.style.display = 'block';
                    if (chartInstance) {
                        chartInstance.destroy();
                        chartInstance = null;
                    }
                }
            } catch (error) {
                dataError.textContent = 'Error: Network issue or server unavailable';
                dataError.style.display = 'block';
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
            }
        }
    </script>
</body>
</html>
