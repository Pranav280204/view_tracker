<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube View Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <h1 class="text-2xl font-bold text-center">YouTube View Tracker</h1>
    </header>
    <main class="container mx-auto p-4 flex-grow">
        <!-- Add Video Form -->
        <section class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Add YouTube Video</h2>
            <form id="add-video-form" class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="video-id" placeholder="Enter YouTube Video ID (e.g., dQw4w9WgXcQ)" class="flex-grow p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition">Add Video</button>
            </form>
            <p id="form-message" class="mt-2 text-sm"></p>
        </section>

        <!-- Video List -->
        <section class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Tracked Videos</h2>
            <ul id="video-list" class="space-y-2">
                {% for video_id in video_ids %}
                <li class="flex justify-between items-center p-2 bg-gray-50 rounded hover:bg-gray-100">
                    <span class="cursor-pointer text-blue-600 hover:underline" onclick="loadVideoData('{{ video_id }}')">{{ video_id }}</span>
                    <button onclick="removeVideo('{{ video_id }}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">Remove</button>
                </li>
                {% endfor %}
            </ul>
        </section>

        <!-- Chart Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">View Count and Gains</h2>
            <canvas id="viewChart" class="w-full h-96"></canvas>
            <p id="chart-message" class="mt-2 text-sm text-gray-600"></p>
        </section>
    </main>
    <footer class="bg-gray-800 text-white text-center p-4">
        <p>&copy; 2025 YouTube View Tracker</p>
    </footer>

    <script>
        let chartInstance = null;

        // Add Video
        document.getElementById('add-video-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const videoId = document.getElementById('video-id').value.trim();
            const messageEl = document.getElementById('form-message');
            
            try {
                const response = await axios.post('/add_video', { video_id: videoId }, {
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.data.success) {
                    messageEl.className = 'mt-2 text-sm text-green-600';
                    messageEl.textContent = response.data.message;
                    // Reload video list
                    const videoList = document.getElementById('video-list');
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded hover:bg-gray-100';
                    li.innerHTML = `
                        <span class="cursor-pointer text-blue-600 hover:underline" onclick="loadVideoData('${videoId}')">${videoId}</span>
                        <button onclick="removeVideo('${videoId}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">Remove</button>
                    `;
                    videoList.appendChild(li);
                    document.getElementById('video-id').value = '';
                } else {
                    messageEl.className = 'mt-2 text-sm text-red-600';
                    messageEl.textContent = response.data.message;
                }
            } catch (error) {
                messageEl.className = 'mt-2 text-sm text-red-600';
                messageEl.textContent = 'Error adding video';
            }
        });

        // Remove Video
        async function removeVideo(videoId) {
            try {
                const response = await axios.post(`/remove_video/${videoId}`);
                if (response.data.success) {
                    document.getElementById('form-message').className = 'mt-2 text-sm text-green-600';
                    document.getElementById('form-message').textContent = response.data.message;
                    // Remove from UI
                    const videoList = document.getElementById('video-list');
                    const items = videoList.getElementsByTagName('li');
                    for (let li of items) {
                        if (li.querySelector('span').textContent === videoId) {
                            videoList.removeChild(li);
                            break;
                        }
                    }
                    // Clear chart if this video was selected
                    if (chartInstance && chartInstance.data.datasets[0].label === videoId) {
                        chartInstance.destroy();
                        chartInstance = null;
                        document.getElementById('chart-message').textContent = 'Select a video to view data';
                    }
                } else {
                    document.getElementById('form-message').className = 'mt-2 text-sm text-red-600';
                    document.getElementById('form-message').textContent = response.data.message;
                }
            } catch (error) {
                document.getElementById('form-message').className = 'mt-2 text-sm text-red-600';
                document.getElementById('form-message').textContent = 'Error removing video';
            }
        }

        // Load Video Data and Update Chart
        async function loadVideoData(videoId) {
            try {
                const response = await axios.get(`/video_data/${videoId}`);
                if (response.data.success) {
                    const data = response.data.data;
                    const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                    const viewCounts = data.map(d => d.view_count);
                    const viewGains = data.map(d => d.view_gain || 0); // Replace null with 0 for chart

                    // Destroy existing chart if it exists
                    if (chartInstance) {
                        chartInstance.destroy();
                    }

                    // Create new chart
                    const ctx = document.getElementById('viewChart').getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: `Views for ${videoId}`,
                                    data: viewCounts,
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    fill: true,
                                    yAxisID: 'y',
                                },
                                {
                                    label: `View Gains for ${videoId}`,
                                    data: viewGains,
                                    borderColor: 'rgba(239, 68, 68, 1)',
                                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                    fill: true,
                                    yAxisID: 'y1',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: { display: true, text: 'Time' }
                                },
                                y: {
                                    title: { display: true, text: 'View Count' },
                                    beginAtZero: false
                                },
                                y1: {
                                    title: { display: true, text: 'View Gain' },
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                    document.getElementById('chart-message').textContent = '';
                } else {
                    document.getElementById('chart-message').className = 'mt-2 text-sm text-red-600';
                    document.getElementById('chart-message').textContent = response.data.message;
                }
            } catch (error) {
                document.getElementById('chart-message').className = 'mt-2 text-sm text-red-600';
                document.getElementById('chart-message').textContent = 'Error loading video data';
            }
        }
    </script>
</body>
</html>
