<!DOCTYPE html>
<html lang="en" class="dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Views Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.min.js" defer></script>
    <script>
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pulse-animation {
            animation: pulse 0.5s ease-in-out;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans text-gray-900 dark:text-gray-100 transition-colors duration-300">
<div class="container mx-auto max-w-5xl p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-4xl font-extrabold text-center text-blue-600 dark:text-blue-400">YouTube Views Tracker</h1>
        <button onclick="toggleDarkMode()" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            Toggle Dark Mode
        </button>
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <p class="text-red-500 dark:text-red-400 font-bold text-center mb-4">{{ message | escape }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% if error_message %}
        <p class="text-red-500 dark:text-red-400 font-bold text-center mb-4">{{ error_message | escape }}</p>
    {% endif %}

    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Add a YouTube Video</h2>
        <form method="POST" action="/add_video" class="space-y-4">
            <div>
                <label for="video_link" class="block text-sm font-medium text-gray-700 dark:text-gray-300">YouTube Video Link</label>
                <input type="url" id="video_link" name="video_link" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., https://www.youtube.com/watch?v=hTSaweR8qMI" required aria-required="true">
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="is_targetable" name="is_targetable" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded">
                <label for="is_targetable" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Allow Target Setting</label>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Add Video</button>
        </form>
    </div>

    {% for video in videos %}
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">{{ video.name | escape }}</h3>
                {% if video.latest_views is not none %}
                    <p class="text-4xl font-extrabold text-blue-600 dark:text-blue-400 mt-2 pulse-animation" aria-live="polite">
                        {{ "{:,}".format(video.latest_views | int) }} Views
                    </p>
                {% else %}
                    <p class="text-xl text-gray-500 dark:text-gray-400 mt-2">No view data available</p>
                {% endif %}
                <img src="https://img.youtube.com/vi/{{ video.video_id }}/0.jpg" class="mt-4 rounded-lg max-w-xs" alt="Thumbnail for {{ video.name | escape }}" loading="lazy">
            </div>
            <div class="flex space-x-2">
                <a href="/export/{{ video.video_id }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Export</a>
                <a href="/remove_video/{{ video.video_id }}" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition" onclick="return confirm('Are you sure you want to remove this video?')" aria-label="Remove {{ video.name | escape }}">Remove</a>
            </div>
        </div>

        <div class="space-y-4">
            {% for date, data in video.daily_data.items() %}
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg">
                <button class="w-full text-left px-4 py-3 bg-gray-100 dark:bg-gray-700 font-semibold text-gray-800 dark:text-gray-200 rounded-t-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition flex justify-between items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{ video.video_id }}_{{ date }}" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="collapse_{{ video.video_id }}_{{ date }}">
                    <span>{{ date }}</span>
                    <span class="transform {% if not loop.first %}rotate-180{% endif %} transition-transform">â–¼</span>
                </button>
                <div id="collapse_{{ video.video_id }}_{{ date }}" class="collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading_{{ video.video_id }}_{{ date }}">
                    <div class="p-4">
                        <div class="overflow-x-auto custom-scrollbar max-h-96">
                            <table class="w-full text-sm text-gray-800 dark:text-gray-200">
                                <thead class="bg-gray-200 dark:bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2">Timestamp (IST)</th>
                                    <th class="px-4 py-2">Views</th>
                                    <th class="px-4 py-2">View Gain</th>
                                    <th class="px-4 py-2">Hourly Gain</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for timestamp, views, view_gain, hourly_gain in data[::-1] %}
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
                                        <td class="px-4 py-2">{{ timestamp }}</td>
                                        <td class="px-4 py-2">{{ "{:,}".format(views | int) }}</td>
                                        <td class="px-4 py-2 {% if view_gain > 0 %}text-green-600 dark:text-green-400{% elif view_gain < 0 %}text-red-600 dark:text-red-400{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                            {{ "{:+,}".format(view_gain | int) }}
                                        </td>
                                        <td class="px-4 py-2 {% if hourly_gain > 0 %}text-green-600 dark:text-green-400{% elif hourly_gain < 0 %}text-red-600 dark:text-red-400{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                            {{ "{:+,}".format(hourly_gain | int) }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <canvas id="viewsChart_{{ video.video_id }}_{{ date }}" class="mt-4" height="100" aria-label="View trends for {{ video.name | escape }} on {{ date }}"></canvas>
                        <script>
                            new Chart(document.getElementById('viewsChart_{{ video.video_id }}_{{ date }}'), {
                                type: 'line',
                                data: {
                                    labels: [{% for timestamp, _, _, _ in data[::-1] %}"{{ timestamp | safe }}",{% endfor %}],
                                    datasets: [{
                                        label: 'Views',
                                        data: [{% for _, views, _, _ in data[::-1] %}{{ views | int }},{% endfor %}],
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                        fill: true,
                                        tension: 0.4
                                    }, {
                                        label: 'View Gain',
                                        data: [{% for _, _, view_gain, _ in data[::-1] %}{{ view_gain | int }},{% endfor %}],
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                        fill: true,
                                        tension: 0.4
                                    }, {
                                        label: 'Hourly Gain',
                                        data: [{% for _, _, _, hourly_gain in data[::-1] %}{{ hourly_gain | int }},{% endfor %}],
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                        fill: true,
                                        tension: 0.4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: { position: 'top' },
                                        title: { display: true, text: '{{ video.name | safe }} - {{ date }} View Trends' },
                                        tooltip: { mode: 'index', intersect: false }
                                    },
                                    scales: {
                                        x: { title: { display: true, text: 'Timestamp (IST)' } },
                                        y: { title: { display: true, text: 'Count' }, beginAtZero: false }
                                    },
                                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                                }
                            });
                        </script>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if video.is_targetable %}
        <div class="mt-6 bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Set Target Views and Time</h4>
            <form method="POST" action="/" class="space-y-4">
                <input type="hidden" name="video_id" value="{{ video.video_id }}">
                <div>
                    <label for="target_views_{{ video.video_id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Views</label>
                    <input type="number" id="target_views_{{ video.video_id }}" name="target_views" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500" required aria-required="true">
                </div>
                <div>
                    <label for="target_time_{{ video.video_id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Time</label>
                    <input type="datetime-local" id="target_time_{{ video.video_id }}" name="target_time" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500" required aria-required="true">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Calculate</button>
            </form>
            {% if video.target_message %}
                <p class="text-red-500 dark:text-red-400 font-bold mt-4">{{ video.target_message | escape }}</p>
            {% elif video.required_views_per_interval is not none %}
                <p class="text-green-600 dark:text-green-400 font-bold mt-4">Required views per 5-minute interval: {{ "{:.2f}".format(video.required_views_per_interval) }}</p>
                <p class="text-blue-600 dark:text-blue-400 mt-1">Target Views: {{ "{:,}".format(video.target_views | int) }}</p>
                <p class="text-blue-600 dark:text-blue-400">Target Time: {{ video.target_time }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
<script>
    document.querySelectorAll('.pulse-animation').forEach(el => {
        setInterval(() => {
            el.classList.remove('pulse-animation');
            void el.offsetWidth;
            el.classList.add('pulse-animation');
        }, 5000);
    });
</script>
</body>
</html>
